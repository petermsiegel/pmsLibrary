:Namespace Markdown

:Section Main_Routines  
â
â -------------------------------------------------------------------------------------------
â Main routines and declarations
â *** Show *** 
  â Show:     hNs@nsâ† newOpts âˆ‡ markdown@CVV
  â markdown: APL char vectors (CVV)  
  â newOpts:  New options for size and JSON option variables. Of the form
  â          ('emoji' 0), ('tables' 1), ('size' (500 400)), 1 for Json true and 0 for false.
  â hNs:      Dyalog Render object (â•WC namespace)
  â           hNs.HTML contains the generated HTML as a character vector with CR's (via HTMLRenderer)
  â           hNs.MD contains the source markdown used to generate it.
  â Once the result returned disappears, the generated HTML object disappears also.
  â Do:              hâ† size Markdown.Show ... 
  â Then to delete:  â•EX 'h' OR hâ†''
  Showâ†{
    0:: â•SIGNAL âŠ‚â•DMX.(('EM' EM)('Message' Message)('EN' EN))
      âºâ† â¬ â‹„ oâ† âº â‹„ hNâ† #.â•NSâ¬ â‹„ hN.MDâ† âµ         â Raw user markdown => hN.MD 
      (s p) h0â† o MergeOpts â•SRC â•THIS            
      h1â† h0 InsertMD Flat hN.MD                  â Insert the markdown text into the HTML/JS src code   
      optsâ† ('HTML'  h1) (s,â¨ âŠ‚'Size') (p,â¨ âŠ‚'Posn') ('Coord' 'ScaledPixel')
      hNâŠ£ 'hN.htmlObj' â•WC 'HTMLRenderer',â¥âŠ† opts    â Render and return the HTML object
  }
  â *** Here ***
  â Here: CVVâ† token@CV âˆ‡ CVV                    
  â   Find payload in char vectors (CV) following ('^\h*â',token,'\h|$') in a vector of CV's. 
  â     - If the token is 'XX', we match /^\h*âXX/ followed by /\h|$/. 
  â       I.e., it will match XX, but not (simple) X, XY, XXX, etc.
  â     - If the "token" is 'XX?' or 'X{1,2}', we will match X, XX, but not XY or XXX.
  â   What follows the token and any following blank is the payload /(.*)/'. 
  Hereâ† {  
    pfx srcâ† âº âµ
    reâ†'^\h*â', pfx, '(?:\h|$)(.*)'                        
    re â•S '\1'âŠ£ src 
  }
  â *** defaults ***
  â defaults: dâ† âˆ‡
  â   Show the default options in JSON format, including 
  â  'size' and 'posn'  used in the HTMLRenderer call.
  âˆ‡ dâ† defaults  ;pfx; defs
    pfxâ†  CR,     '  // HTMLRenderer opts in Json format'
    pfx,â† CR, CR,â¨'     size: [', '],',â¨ 1â†“âˆŠ',',Â¨â•Â¨sizeDef 
    pfx,â†     CR,â¨'     posn: [', '],',â¨ 1â†“âˆŠ',',Â¨â•Â¨posnDef 
    defsâ† '^\h{4}' â•R ' ' RE._SimpleâŠ¢ 'J[CO]' Here â•SRC â•THIS 
    dâ† '{', pfx, defs, '}'  
  âˆ‡
  âˆ‡ dâ† defaults2  ;defs; ns; pfx 
    pfxâ†  CR,     '  // HTMLRenderer opts in APL format'
    pfx,â† CR, CR,â¨'     (''size'' [', ']),',â¨ 1â†“âˆŠ',',Â¨â•Â¨sizeDef 
    pfx,â† CR,â¨'     (''posn'' [', ']),',â¨ 1â†“âˆŠ',',Â¨â•Â¨posnDef 
    nsâ† â•JSONâ 'Dialect' 'JSON5'âŠ¢ 'J[CO]' Here â•SRC â•THIS 
    defsâ† âˆŠCR,â¨Â¨ ns.{ ('(''',âµ,''' ',â•â•OR âµ), ')' }Â¨ns.â•NL Â¯2 
    dâ† '(', pfx, defs, ')'  
  âˆ‡
  â example: eâ† âˆ‡
  â   A markdown example.  
  âˆ‡ eâ† example  
    eâ† 'EX' Here â•SRC â•THIS                                        
  âˆ‡
  â help: {html@ns}â† âˆ‡
  â   To see the markdown source, see: html.MD 
  âˆ‡ {html}â† help ; src  
    htmlâ† ('size',â¥âŠ‚ 900 900)('posn',â¥âŠ‚ 5 5) Show 'HLP' Here â•SRC â•THIS 
    {}â
  âˆ‡

â -------------------------------------------------------------------------------------------
â Constants
  â•IO â•MLâ† 0 1 
  CRâ† â•UCS 13
â -------------------------------------------------------------------------------------------
â Variables 
  sizeDef posnDefâ† (800 1000) (5 5)                  â size: height, width; posn: y, x 
  exampleTâ† ''                                       â See  âˆ‡ example âˆ‡  
:EndSection â Main_Routines

:Section Internal_Utilities
â -------------------------------------------------------------------------------------------
  â *** InsertMD ***
  â InsertMD:   CVVâ† CVV âˆ‡ CVV                             
  â   Insert âº:markdown into âµ:html at ___MYTEXT___
  â   Don't process escape chars in the replacement field...
  InsertMDâ† {  
      '^\h*___MYTEXT___.*$'  â•R âµ RE._Simple RE._Once RE._RE10âŠ¢ âº 
  }
  â *** Flat ***
  â Flat:  CcrVâ† âˆ‡ CVV                               
  â   Convert vector of char vectors into a CV with carriage returns.
  Flatâ† {Â¯1â†“ âˆŠâµ,Â¨ CR}âŠ†
  
  â *** HtmlRender ***
  â HtmlRender: ns.htmlObj@HTMLRenderer_objâ† size@I2 posn@I2 âˆ‡ html@CVV
  â   Returns an html renderer object generated by â•WC.
  HtmlRenderâ† {  
    s pâ† âº 
    parmsâ† ('HTML',â¥âŠ‚ âµ) (s,â¨ âŠ‚'Size') (p,â¨ âŠ‚'Posn') ('Coord' 'ScaledPixel')
    nsâ† #.â•NSâ¬                                       â Private ns for generated obj 
    _â† 'ns.htmlObj' â•WC 'HTMLRenderer',â¥âŠ† parms     â Generate the renderer as ns.htmlObj. 
    ns.htmlObj                                        â Return the generated object itself.
  }  

  â *** MergeOpts ***
  â MergeOpts: 
  â    âˆ˜ Load old Markdown options (in Json format);
  â    âˆ˜ Merge any new options passed from APL, replacing 0 and 1 with (âŠ‚'false') and (âŠ‚'true'); 
  â    âˆ˜ Separate off the pseudo-option `size: [n1 n2]` and returning separately as (n1 n2);
  â    âˆ˜ Replace the ___OPTS___ stub in the HTML code with the up-to-date Json options.
    â JMerge: 
    â   âˆ˜ Merge new APL-specified options into existing Json options
    â   âˆ˜ Returning the new or default size@IV[2]
    â ((sizeOut@I[2] posnOut@I[2]) jsonOut@CVV)â† [jsonInâ†''] (sizeDef@I[2] posnDef@I[2] âˆ‡) opt1 [opt2 ...]
    â jsonIn:
    â   a Json5 list of key-value pairs or null.
    â sizeDef, posnDef
    â   the default size/posn variables for use in an HTMLRenderer call.
    â   âˆ˜ Each has 2 items: (integers: height, width) and posn (integers: y and x offsets)
    â   âˆ˜ Their value  will be the Â¨sizeÂ¨ and Â¨posnÂ¨ returned, unless an option overrides it.
    â optN:
    â   an APL-style key-value pair of the form ('Name' value).
    â   A value of 1 or 0 will be replaced by âŠ‚'true' or âŠ‚'false', respectively.
    â   Special case: keys 'size' and 'posn' will have their value replace the default size.
    â       The size value must be of the form (height width);
    â       The posn value must be of the form (y and x offsets):
    â       ('size' (1000 600)) and ('posn' (5 5)) 
    â sizeOut, posnOut
    â   The values set per above, either the defaults or explicitly set values.
    â jsonOut:
    â   The 2nd element returned; a char. string representing the udpated
    â   JSON5 key-value pairs.
  MergeOptsâ† { 
    optEâ† 'Options must consist of exactly two items: a keyword and a scalar value' 11
    JMergeâ†{   
        hNmsâ† 'size' 'posn'
        _J5â† â 'Dialect' 'JSON5' 
        JInâ† { 0=â‰¢âµ:â•NS â¬ â‹„ â•JSON _J5  âµ }   
        Listâ† { ,âˆ˜âŠ‚â£(2=|â‰¡âµ)âŠ¢ âµ }                  â Convert single opt (depth 2) to list (depth 3)
        â™Mapâ†{(1 0â³âŠ‚âµ)âŠƒ(âŠ‚âŠ‚'true')(âŠ‚âŠ‚'false')âµ}    â APL 1 0 => Json true false 
        â™Setâ† { âº âºâº.{ ââº,'â†âµ' } âµ }              â Merge new (APL) options into (Json) default values
        Mergeâ† {(âº â™Setâˆ˜â™Map)/Â¨âµ} 
        HOutâ† 'ns.' { 0â‰  â•NC âºâº,âº: (â•EX âºâº,âº)âŠ¢ â•OR âºâº,âº â‹„ âµ }
      â ----------
        âºâ† '{}' 
        j hDefâ† âº âºâº
      0=â‰¢âµ:  j,â¨â¥âŠ‚ hDef  
        optsâ† List âµ
      2âˆ¨.â‰  â‰¢Â¨ opts: â•SIGNAL/ optE 
        nsâ† JIn j â‹„ _â† ns Merge opts
        hOptsâ† hNms HOutÂ¨ hDef
        hOpts,â¥âŠ‚  â•JSON _J5 ns 
    }
    optsApl srcâ† âº âµ 
    jStubâ† '___OPTS___'
    jOldâ† '{', CR, (Flat 'JO' Here src), CR, '}'                 â J: Default JSON
    s_p jCurâ† jOld (sizeDef posnDef JMerge) optsApl              â s_p: size pair and posn pair
    JUpdateâ† jStub â•R jCur RE._Simple RE._Once                      
    s_p,â¥âŠ‚ JUpdate 'HT' Here src                                 â H: Includes stub for JSON
  } 
:EndSection â Internal_Utilities

:Section Regular_Expressions
  :Namespace RE
     _Simpleâ† â ('ResultText' 'Simple')('EOL' 'CR')
     _Onceâ†   â 'ML' 1
     _RE10â†   â 'Regex' (1 0)
  :EndNamespace 
:EndSection â Regular_Expressions 

:Section Alien 
  :Section Example 
â -------------------------------------------------------------------------------------------
â  example: Markdown example source 
   âEX # An example of *Markdown* in the ***Showdown*** dialect
   âEX
   âEX
   âEX ## A Paragraph (1)
   âEX
   âEX This shows how to separate lines of a paragraph via 2 trailing spaces, 
   âEX just like **this:**  
   âEX there are 2 spaces after the characters **this:** above.
   âEX 
   âEX ## A Paragraph (2)
   âEX This is a paragraph with **bold** text and this Emoji smile :smile: is generated via 
   âEX the expression :smile\:.  Since ('simpleLineBreaks' 0) is the default, 
   âEX a single paragraph can be generated from multiple contiguous lines, as long as none
   âEX has 3 (or more) trailing spaces. We have five (5) such lines here making one paragraph. 
   âEX This face ğŸ˜œ is represented _directly_ in APL. 
   âEX
   âEX **Note**:
   âEX If you want contiguous lines to include linebreaks, set ***('simpleLineBreaks' 1)***
   âEX in the *APL* options.
   âEX 
   âEX #### These lines produce level 1 (#) and level 2 (##) headings:
   âEX 
   âEX      This is a level 1 heading!
   âEX      ==========================
   âEX 
   âEX      This is a level 2 heading.
   âEX      --------------------------
   âEX 
   âEX #### Below are the level 1 and level 2 headings produced from the source above!
   âEX 
   âEX This is a level 1 heading!
   âEX ==========================
   âEX 
   âEX This is a level 2 heading.
   âEX --------------------------
   âEX 
   âEX 1. This is a bullet
   âEX      * This is a *sub-*bullet.
   âEX           * A sub***ber*** bullet.
   âEX           * And another!
   âEX 1. This is another top-level bullet. 
   âEX 1. As is this.
   âEX      We right now do NOT allow simplified autolinks to places like http://www.dyalog.com.
   âEX
   âEX     > A blockquote would look great here...
   âEX
   âEX 1. A final bullet?
   âEX 
   âEX ### Tonnage of [Columbus' Ships](http://columbuslandfall.com/ccnav/ships.shtml)\. 
   âEX 
   âEX   | Ship  | NiÃ±a    | Pinta | Santa Maria |
   âEX   |: ---- |: ----- :|:-----:|:-----:|
   âEX   | Type | caravel | caravel | carrack |
   âEX   | Tonnage | 50-60 tons   | 70 tons  | 100 tons |
   âEX   | Perceived size | ~~big~~| ~~bigger~~ | ~~gigantic~~ |
   âEX   | Actual size| shrimpy shrimp | small shrimp | jumbo shrimp |
   âEX
   âEX **Note**: The above link to Columbus' Ships is an *explicit* link.
   âEX
   âEX ----
   âEX 
   âEX This is code: `â³2` 
   âEX 
   âEX This is *also* code: <code>â³3</code> 
   âEX 
   âEX And so is this:
   âEX 
   âEX      â Set off with 6 blanks
   âEX        âˆ‡ Pâ† A IOTA B
   âEX          Pâ† A â³ B
   âEX        âˆ‡
   âEX
   âEX This should work. Does it? (**Yes**)
   âEX ```
   âEX +/âºâ³âµ
   âEX -\âµâ³âº
   âEX ```
   âEX
   âEX ### What about tasks?
   âEX + [x] This task is done
   âEX - [ ] This is still pending
   âEX + [x] We knocked this out of the park!
   âEX 
   âEX ### Goodbye:exclamation::exclamation::exclamation:
   âEX 
  :EndSection 

  :Section HTML_Code 
â -------------------------------------------------------------------------------------------
â  Markdown-to-Html code-- "showdown" javascript
   âHT <!DOCTYPE html>
   âHT <html>
   âHT <head>
   âHT   <title>Showdown Example</title>
   âHT   <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" 
   âHT        integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA==" 
   âHT        crossorigin="anonymous" referrerpolicy="no-referrer">
   âHT   </script>
   âHT </head>
   âHT <body>
   âHT   <div id="markdown-content" style="display:none;">
   âHT     ___MYTEXT___             // User Markdown will go here...
   âHT   </div>
   âHT   <div id="html-content"></div>
   âHT   <script>
   âHT     var markdownText = document.getElementById('markdown-content').textContent;
   âHT     var opts = ___OPTS___;    // Json Markdown options go here...
   âHT     const converter = new showdown.Converter(opts);
   âHT     const html = converter.makeHtml(markdownText);
   âHT     document.getElementById('html-content').innerHTML = html;
   âHT   </script>
   âHT </body>
   âHT </html>
  :EndSection 

  :Section Json Options
â -------------------------------------------------------------------------------------------
â  Json Markdown Option Defaults. Used in place of ___OPTS___ above 
â     var opts = {
   âJC      // Json Markdown options (Showdown dialect)
   âJC      // âˆ˜ For all binary (true/false) options except ghCodeBlocks, 
   âJC      //   the "built-in" default value is (false), potentially overridden here!
   âJC      // -------------------------------------------------------------------------------
   âJC      // Simple line break: If true, simple line break in paragraph emits <br>.
   âJC      //                    If false (default), simple line break does not emit <br>.
   âJO         simpleLineBreaks: false, 
   âJC      // Enable tables 
   âJO         tables: true,
   âJC      // Enable strikethrough 
   âJO         strikethrough: true,
   âJC      // Omit extra line break in code blocks
   âJO         omitExtraWLInCodeBlocks: true,
   âJC      // Enable GitHub-compatible header IDs
   âJO         ghCompatibleHeaderId: true,
   âJC      // Fenced code blocks. True (default), enable code blocks with ``` ... ``` 
   âJO         ghCodeBlocks: true,
   âJC      // Prefix header IDs with "custom-id-"
   âJO         prefixHeaderId: 'custom-id-',
   âJC      // Enable emoji support 
   âJO         emoji: true,
   âJC      // Enable task lists 
   âJO         tasklists: true,
   âJC      // Disable automatic wrapping of HTML blocks
   âJO         noHTMLBlocks: false,
   âJC      // Allow simple URLs like http://dyalog.com in text to be treated as actual links. 
   âJC      // Keep in mind that selecting a link will leave the Markdown page, w/o an easy way  
   âJC      // to return (except by recreating the page).
   âJO         simplifiedAutoLink: false,         
   âJC      // Enable support for setting image dimensions in Markdown,  
   âJC      //      e.g. ![foo](foo.jpg =100x80)  OR ![baz](baz.jpg =80%x5em)
   âJO         parseImgDimensions: false,  
â    }
  :EndSection 

  :Section Help 
   âHLP ## Markdown Utility (namespace)
   âHLP 
   âHLP | | |
   âHLP |: --- :|: --- |
   âHLP | :arrow_forward: |Use Markdown in an HTMLRenderer session in Dyalog|
   âHLP | :arrow_forward: |Based on the **Showdown** dialect of *Markdown*. See: https://showdownjs.com/. |
   âHLP 
   âHLP ## Key Routines
   âHLP 
   âHLP | Routine | Usage                                                   |         | Call   | Syntax |       |
   âHLP |: ----   |: ---                                                    |   ---  :|: ---  :|   ---  |: ---  |
   âHLP | Show    | Process and Display Markdown text via the HTMLRenderer  | HtmlNsâ† | [opts] | âˆ‡      | CVV   |
   âHLP | example | A bells-and-whistles Markdown example                   |CVVâ†     |        | âˆ‡      |       |
   âHLP | help    | Display (this) help information |[HtmlNsâ†]|| âˆ‡ ||
   âHLP | defaults | Show Markdown & HTMLRenderer defaults used |CVâ†||âˆ‡||
   âHLP | Here | Pull Markdown from APL comments 'âtok' in âµ, a vector of "strings" | CVVâ† |'tok' |âˆ‡ | CVV |
   âHLP |      | where âµ may be `â•SRC â•THIS`, `â•NR âŠƒâ•XSI`, etc. |   |  |  |   |
   âHLP | Flat | Convert APL char vector of vectors to a simple char vector (with CR's) | CVâ† || âˆ‡ | CVV |
   âHLP 
   âHLP 
   âHLP ## Using Markdown.Show:
   âHLP 
   âHLP [**html**â†]  [**options**] *Markdown.Show* **markdown** 
   âHLP 
   âHLP where **markdown** is 
   âHLP 
   âHLP - a vector of character vectors containing standard "Showdown-style" Markdown, 
   âHLP often extracted (via Markdown.Here) from comments in the current function or namespace.
   âHLP 
   âHLP and **options** are
   âHLP 
   âHLP - APL Variant (â ) style specifications of [ğŸ] HTMLRenderer and [ğŸ] Markdown JSON5 options.      
   âHLP    
   âHLP *Markdown.Show* returns the value **html**,
   âHLP
   âHLP - an HTMLRenderer-generated namespace, augmented with MD, a copy of the generated Markdown source;
   âHLP - When the variable html goes out of scope or is expunged, the HTML object rendered disappears.
   âHLP                             
   âHLP ### Options sent to HTMLRenderer
   âHLP | Show option | What HTMLRenderer sees | 
   âHLP |: ---- |: ----- | 
   âHLP |   ('size' (800 1000))              | ('Size' 800 1000) |         
   âHLP |   ('posn' (5 5))                   | ('Posn' 5 5) |  
   âHLP 
   âHLP ### Options converted to Json5 and sent to Javascript Markdown Showdown translator 
   âHLP | Show option | What Markdown sees | 
   âHLP |: ---- |: ----- |          
   âHLP |   ('simpleLineBreaks' 0)           | simpleLineBreaks: false,  |            
   âHLP |   ('tables' 1)                     | tables: true,      |                   
   âHLP |   ('strikethrough' 1)              |  strikethrough: true,   |               
   âHLP |   ('omitExtraWLInCodeBlocks' 1)    |  omitExtraWLInCodeBlocks: true,  |      
   âHLP |   ('ghCompatibleHeaderId' 1)       |  ghCompatibleHeaderId: true, |          
   âHLP |   ('ghCodeBlocks' 1)               |  ghCodeBlocks: true,   |                
   âHLP |   ('prefixHeaderId' 'custom-id-')  |  prefixHeaderId: 'custom-id-',   |      
   âHLP |   ('emoji' 1)                      |  emoji: true,           |               
   âHLP |   ('tasklists' 1)                  |  tasklists: true,       |               
   âHLP |   ('noHTMLBlocks' 0)               |  noHTMLBlocks: false,    |              
   âHLP |   ('simplifiedAutoLink' 0)         |  simplifiedAutoLink: false  | 
   âHLP |   ('parseImgDimensions' 0)         |  parseImgDimensions: false, |
   âHLP  
   âHLP ### Notes
   âHLP |     |     |
   âHLP | --- | --- |
   âHLP | ğŸ­. | See **Showdown** documention, especially for the Github options.| 
   âHLP ||E.g. https://github.com/showdownjs/showdown (general)|
   âHLP ||E.g. https://github.com/showdownjs/showdown/wiki/emojis (showdown emojis)|
   âHLP | ğŸ®. | Call **Markdown.defaults** for the list of option variables (shown in Javascript format).|
   âHLP 
   âHLP ### Markdown.Show
   âHLP Show returns the resulting HTML as a vector of character vectors.
   âHLP 
   âHLP ğŸ›ˆ To see the returned HTML, store the result of Â¨ShowÂ¨ in a variable:
   âHLP
   âHLP         htmlâ† Markdown.Show example
   âHLP 
   âHLP ğŸ›ˆ To remove the returned HTML permanently, delete or reset the variable:
   âHLP
   âHLP         â•EX 'html'    OR     htmlâ†''
   âHLP 
   âHLP ğŸ›ˆ To temporarily stop displaying the returned HTML, set html variable "visible" to 0:
   âHLP
   âHLP         html.visibleâ†0     â To redisplay, html.visibleâ†1
   âHLP 
   âHLP ğŸ›ˆ To view the markdown example source:
   âHLP 
   âHLP          â•ED 'html.MD'    
   âHLP      OR 
   âHLP          {â•ED 't'âŠ£tâ†âµ} Markdown.example
   âHLP 
   âHLP ğŸ›ˆ See HTMLRenderer for other APL-side variables.
   âHLP  
   âHLP ### Markdown Utilities and Examples
   âHLP #### :arrow_forward: Markdown.defaults 
   âHLP      returns all the HTML-directed and Markdown Showdown-dialect Json5 variables.
   âHLP 
   âHLP #### :arrow_forward: Markdown.Here
   âHLP makes it easy to take comments in APL functions or namespaces and return them as Markdown or HTML code.
   âHLP 
   âHLP        vvâ† 'tok' Markdown.Here âŠƒâ•XSI         â Find APL comment line 'âtok' in the current function.
   âHLP        vvâ† 'tok' Markdown.Here â•SRC â•THIS    â Find APL comment line 'âtok' in the current namespace.
   âHLP 
   âHLP #### :arrow_forward: Markdown.Flat 
   âHLP converts a vector of character vectors to a flat char vector with carriage returns. 
   âHLP 
   âHLP #### :arrow_forward: Markdown.example 
   âHLP contains a nice example. (See also the source for Markdown.help)
   âHLP 
   âHLP ğŸ›ˆ To see the example source, do:
   âHLP 
   âHLP        â•ED 'a'âŠ£ aâ† Markdown.example
   âHLP 
   âHLP ğŸ›ˆ To see the result, do: 
   âHLP  
   âHLP        xâ† Markdown.(Show example)
   âHLP 
   âHLP #### :arrow_forward: Markdown.help
   âHLP displays help information for this Markdown namespace.
   âHLP 
   âHLP        Markdown.help 
   âHLP
   âHLP The source for markdown help can be viewed several ways, including this one:
   âHLP
   âHLP       {â•ED 't.MD'âŠ£ tâ† âµ} Markdown.help
   âHLP  
  :EndSection 
:EndSection â Alien  
:EndNamespace 
